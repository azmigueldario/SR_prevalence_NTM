---
title: "Analysis: systematic review of nontuberculous mycobacteria prevalence in cystic fibrosis"
author: "MDP"
date: "10/10/2021"
output: 
  html_document:
    toc: true
    toc_depth: 2
    theme: united
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=F)
```

# Introduction

Our systematic review is a comprehensive picture of all studies and registry reports that include prevalence/incidence of _nontuberculous mycobacteria (NTM) in cystic fibrosis_ population

The analysis will be performed in R (v4.1.1) with __Github__ version control repository.We will analyze the prevalence as a proportion and the incidence as a rate, depending on availability in results. The data from the study cohort is saved in the `input` sudirectory as a `.csv` file. 

To conduct meta-analysis of proportions, we require the following observations per study 
- _sample size_
- _study id_
- _number of events_

Other variables are included to perform complementary analyses. 

### Aims
1. Explore our data and summarize it briefly
2. Explore publication bias and produce plots
3. Conduct meta-analysis of selected studies and produce summary plots
4. Perform pre-specified subgroup analysis
5. Conduct exploratory sensitivity analysis, meta regression and hierarchical analysis

### Suggestions for analysis 


-	Contemporary cohort, maybe including only data from 2010 and onwards _#done_
- Subgroup by high quality studies according to quality appraisal _done_
- Control for overlap over years in registry studies with the random effects model (dependency in data) _#done_
- Subgroup of registry data vs peer-reviewed data _#done_
- Also, subgroup according to dates or regions _#done_
- Tips for discussion: implications of screening, raising prevalence?, implications of design, baseline status before modulators
- Contact canada/australia registries for raw numbers of NTM cases _#done, not available_
- Corroborate that the numbers in the UK and ECFS registries match _#done, numbers match properly_ 

# Data wrangling

Load required packages

- `dmetar` with its associated packages for some helpful functions 
- `meta` and `metafor` for meta-analysis, funnel plots, forest plots and meta-regression
- `knitr` allows us to produce nicely formatted tables in the report

```{r, warning=FALSE, message=FALSE}
# devtools::install_github("MathiasHarrer/dmetar")
require(dmetar)
require(meta)
require(metafor)
require(tidyverse)
require (knitr) 
```

## Data import 

We start by importing the dataset, changing all character variables to factors and doing some cleaning. 
- _used_registry_ contains the name of the registry used

```{r, message=FALSE}
input_data <- read_csv("./input/20210912-data_meta_analysis_qa.csv")  %>% 
  mutate(mabs_infection = as.numeric(mabs_infection),
         used_registry=fct_explicit_na(used_registry, "no")) 

# table(input_data$used_registry)

glimpse(input_data)
```

## Data wrangling

To produce quality plots, I create a variable in the form `Author YYYY`. 

```{r}
messy_data <-  input_data %>% 
  mutate(
    study=gsub("([a-z])([0-9])", "\\1 \\2", id),
    study=stringr::str_to_title(study) # changes first letter to upper-case
  )
```

We unify the type of study design under 3 categories and create an indicator variable for registry_report(y/n)

```{r}
table(messy_data$study_design)

messy_data<- messy_data %>%
  mutate(study_design=case_when(study_design=="Cross-sectional study" ~ "cross_sectional",
                                study_design=="Registry report" ~ "registry",
                                TRUE ~ "cohort"),
         is_registry=case_when(study_design=="registry" ~ 1,
                               TRUE ~ 0))

messy_data %>% 
  count(is_registry, study_design) %>% 
  kable()
```

We create a grouping variable according to the first year of data collection of a study. We use 5-years intervals between 2000 and 2020

```{r}
messy_data<- messy_data %>%
  mutate(
    before_year=case_when(
      first_year_data<2000 ~ "2000 or before",
      first_year_data<=2004 ~ "2001-2004",
      first_year_data<=2009 ~ "2005-2009",
      first_year_data<=2014 ~ "2010-2014",
      TRUE ~ "2015 or after")) 

table(messy_data$before_year) %>% 
  kable()
```

The variable `region` is has some low numbers in some of the levels {AUS, ME & LAC}. For further analysis, I group them together in a single new level (others)

```{r}
# table(messy_data$region)

messy_data <- messy_data %>% 
  mutate(region1=case_when(region=="NAM"~"NAM",
                           region=="EUR"~"EUR",
                           TRUE ~ "Other"))
count(messy_data, region1) %>% 
  kable()
```

## Cleaning quality assessment data

To plot risk of bias graphs we need a specific data structure. 

- We used the Joanna Briggs appraisal tool for prevalence studies with answer options = {Yes, No, Unclear}. 
- We standardize to Cochrane categories coding _Yes=Low, No=High, Unclear=Unclear_ 

```{r}
messy_data<- messy_data %>% 
  mutate_at(.vars = vars(starts_with("q")), 
            .funs = function(x) recode_factor (x, 
                                       `Yes` = "Low", 
                                       `Unclear` = "Unclear", 
                                       `No` = "High", 
                                       `Missing` = "Missing")) 
messy_data<- 
  messy_data %>% 
  mutate(across(starts_with("qa"), ~ recode_factor (.x,
                                                    `Yes` = "Low",
                                                    `Unclear` = "Unclear",
                                                    `No` = "High",
                                                    `Missing` = "Missing")))
table(prevalence1$Q1_Sampling_frame)
```

 
Finally we rename the quality assessment variables so they represent more clearly each of the domains of the Joana Briggs tool for quality asessment. It will also make for prettier plots.

```{r}
messy_data <-  
  messy_data %>%
  rename(
    "Q1_Sampling_frame"="qa_sampleframe",
    "Q2_Sampling_scheme"="qa_sampling",
  "Q3_Sample_size"="qa_samplesize",
  "Q4_Population_description"="qa_popdescription",
  "Q5_Coverage_of_sample"="qa_coveragesample",
  "Q6_Identification_methods"="qa_idmethods",
  "Q7_Standardized_measurement"="qa_standard_measurement",
  "Q8_Statistical_calculation"="qa_stats",
  "Q9_Response_rate"="qa_responserate")
  
colnames(messy_data) [17:25] %>% write.csv(file="a.csv")
  
table(prevalence1$Q1_Sampling_frame) 
```

- Also, for the meta-analysis, we will conduct a sensitivity analysis based on the overall quality of the studies. We make the following definitions based on the author's considerations of the most important factors in the quality appraisal:

    + Low risk must have a low risk in: sampling frame, sampling scheme, statistical calculation and NTM identification methods. It must also not have high risk in standardized measurement of the cohort. 
    + High risk if there is a high risk in any of the following: sampling frame, sampling scheme, sampling size, identification methods, statistical methods and description of the population 
    + Unclear risk for all other groups where there is not enough data to classify

```{r}
prevalence1 <- 
  prevalence1 %>%
  mutate(Overall_Q=case_when(
    Q1_Sampling_frame=="High" | Q2_Sampling_scheme=="High" | Q3_Sample_size=="High" |
      Q4_Population_description =="High" | Q6_Identification_methods=="High" |
      Q8_Statistical_calculation=="High" ~ "High",
    Q1_Sampling_frame=="Low" & Q2_Sampling_scheme=="Low" & 
      Q4_Population_description=="Low" & Q7_Standardized_measurement!="High" &
      Q8_Statistical_calculation=="Low" ~ "Low",
    TRUE ~ "Unclear")) 

table(prevalence1$Overall_Q) %>% 
  kable()
```


The last step is to transform all character variables into factor so they can be used by the functions. 

```{r}
 prevalence1 <-  prevalence1%>% 
  mutate(across(where(is.character), as_factor))
```


# Exploratory data analysis 

Let us summarize some aspects of our data. 

- How many studies are registry reports? 
- How many studies include pediatric, mixed or adult population ?  

```{r}
prevalence1 %>% 
  count(study_design) %>% 
  mutate(prop = prop.table(n)*100,
         prop = round(prop, 1)) %>% 
  kable()

prevalence1 %>% 
  count(age_group) %>% 
  mutate(prop = prop.table(n)*100,
         prop = round(prop, 1)) %>% 
  kable()

# excluding registry reports
prevalence1 %>%
  filter(is_registry==0) %>% 
  count(age_group) %>% 
  mutate(prop = prop.table(n)*100,
         prop = round(prop, 1)) %>% 
  kable()
```

- Summarize the first year of data in the studies 

```{r}
quantile(prevalence1$first_year_data, na.rm = T) %>% 
  kable()
```

- What is the range of data_years included in the studies? 

```{r}
ggplot(prevalence1, aes(y=first_year_data)) +
  geom_boxplot() + 
  labs(title= "First year of data collected in study",
       y="") +
  theme_classic()+
  theme(axis.text.x = element_blank())

# establish number of digits in printed results
options(digits = 5)

# excluding registry reports 
prevalence1 %>% 
  filter(is_registry==0) %>% 
  summarize(
    mean_year=mean(first_year_data, na.rm=T),
    sd=sd(first_year_data, na.rm=T),
    quantile_years= quantile(first_year_data, na.rm = T)
  ) %>% 
  as.data.frame() %>%  # as.dataframe() prints all decimal values, a tibble does not 
  kable()

prevalence1 %>% 
  filter(is_registry==0) %>% 
  ggplot(aes(y=first_year_data)) +
  geom_boxplot() + 
  labs(title= "First year of data in study",
       subtitle = "No registry reports",
       y="") +
  theme_classic() +
  theme(plot.subtitle=element_text(color="red4"),
        axis.text.x = element_blank()) 
```

- How many were conducted before 2010 and 2000?
    + We use the 5-year groups we previously defined to summarize this data

```{r}
prevalence1 %>%  
  filter(is_registry==0) %>%
  count(before_year) %>% 
  mutate(prop=prop.table(n)*100,
         prop=round(prop,1)) %>% 
  kable()

prevalence1 %>% 
  filter(is_registry==0) %>%
  ggplot(aes(x=before_year, fill=factor(before_year)))+
  geom_bar() +
  labs(title= "Frequency of studies by date of data collection",
       subtitle = "No registry reports",
       x= "Date range") +
  ylab("") +
  scale_fill_brewer(palette = "Set1") +
  theme(legend.position = "none")
```

- What is the median sample size of the non-registry studies?
    + Does this change according to the year of data collection?

```{r}
## for registry reports or registry based studies
prevalence1 %>% 
  filter(is_registry==1 | used_registry=="yes") %>% 
  summarize(
  sample_size_quantiles=quantile(sample_size_cf, na.rm=T)) %>% 
  kable()

# observational studies
prevalence1 %>% 
  filter(is_registry==0 & used_registry=="no") %>% 
  summarize(
  sample_size_quantiles=quantile(sample_size_cf, na.rm=T)) %>% 
  kable()

prevalence1 %>% 
  filter(is_registry==0 & used_registry=="no") %>% 
  ggplot(aes(y=sample_size_cf, x=first_year_data)) +
  geom_point() +
  labs (title="Sample size according to year of data",
       subtitle="No registry reports included",
       x="First year of data collection",
       y="CF sample size") +
  theme(plot.subtitle = element_text(color="red4")) 
```

## How many studies report every outcome

__NTM disease period prevalence was reported in 9 studies__
__NTM disease point prevalence in only 1__
__Incidence proportion was reported in 4 studies__

Point prevalence NTM infection

```{r}


prevalence1 %>% 
  filter(last_year_data - first_year_data < 2 ) %>%
  count() %>% 
  mutate(prop=round(n/93*100, 1))

prevalence1 %>% 
  filter(last_year_data - first_year_data >= 2 |
          is.na(last_year_data) ) %>%
  count() %>% 
  mutate(prop=round(n/93*100, 1))



summarize(
  sample_size_quantiles=quantile(sample_size_cf, na.rm=T)) %>% 
  kable()
```


# Meta analysis of NTM infection

## All studies meta-analysis

We will first approximate the prevalence of NTM infection using all data. 
- Numerator: `all_ntm_infection` which contains the number of events
- Denominator: `sample_size_cf`  

Some studies do not include raw count of events and thus, cannot be summarized because an estimate of variance cannot be calculated

```{r}
table(prevalence$all_ntm_infection, useNA = "always")
```

Then fit our meta-analysis with the `meta::metaprop` function
 - sm=PLOGIT specifies to use the logit transformation for the proportions
 - hakn=TRUE applies an adjustment for more conservative confidence intervals
 - comb.random=T specified a random effects model
 - method="GLMM" implies a generalized linear model, recommended over inverse variance for proportions
 
```{r}
meta.full <-  prevalence1 %>% 
  filter (!is.na(all_ntm_infection)) %>%
  metaprop(event = all_ntm_infection,
           n = sample_size_cf,
           studlab = study,
           data = .,
           method = "GLMM",
           sm = "PLOGIT",
           comb.random = TRUE,
           hakn = TRUE,
           title = "NTM infection prevalence")
```

```{r, eval=F}
print.meta(meta.full,
           details = F,
           bystud=F)
```

Now, lets produce a forest plot for this MA, a little bit crowded

```{r}
forest.meta(meta.full, 
            sortvar = TE,
            predict = TRUE, 
            comb.fixed = F,
            layout="RevMan5",
            colgap.forest.left = "5.5cm",
            print.I2.ci = T,
            rightcols = c("effect", "ci", "w.random"),
            study.results =  F,
            xlim=c(0,0.2))
```

The results using the metafor package and the same conditions are roughly the same. See below. 

# Pre-specified subgroup analysis

## According to study design (registry or not) 

We first use the meta package as it allows us to produce quality forest plots for publication. 

```{r}
update.meta(meta.full,
            byvar = is_registry, 
            tau.common = F) %>% 
  print.meta(bystud=F)
# Subgroup test is significant but not relevant because the change is (98.9 vs 99.8)

update.meta(meta.full,
            byvar = study_design, 
            tau.common = F) 
# reduced heterogeneity according to study design, lower in cohort studies (82% vs 99%)
```

The function `forest.meta` can be used to plot a subgroup analysis in the following way. 

- We feed the resulting `meta` object to the function
- Specify if we will plot random or fixed with `comb.random` and `comb.fixed` respectively
- The columns on the right can be specified to `rightcols`
- `study.results` and `subgroup` are logicals that indicate if subgroup and individual studies should be plotted
- The `colgap` arguments define the space between columns in the left or adjacent to the forest plot
- The `layout` argument lets us format the forest plot in a similar fashion to the _RevMan5_ software

Here, we print the forest plot for the subgroup analysis 

```{r}
update.meta(meta.full,
            byvar = study_design, 
            tau.common = F) %>% 
  forest.meta(x=.,
              comb.fixed = F,
              rightcols = c("effect", "ci", "w.random"),
              study.results =  F,
              overall = T,
              xlim=c(0, 0.2),
              colgap.left = "2cm",
              colgap.forest = "1cm",
              layout = "RevMan5", 
              col.by = "black",
              test.subgroup.random = T)
```

### Registry studies only meta-analysis

Meta-analysis of only registry studies. 

1. We exclude data from the brazilian registry because the coverage of NTM sampling is not reported and probably there is poor screening practices
2. Some Canadian and all Australian reports could not be summarized as they did not have raw numbers reported or the proportion with a 95% confidence interval

```{r}
prevalence1 %>% 
  filter (!is.na(all_ntm_infection)) %>%
  filter (is_registry==1, 
          used_registry!="Brazil") %>% 
  metaprop(event = all_ntm_infection,
           n = sample_size_cf,
           studlab = study,
           data = .,
           method = "GLMM",
           sm = "PLOGIT",
           comb.random = TRUE,
           hakn = TRUE,
           title = "NTM infection prevalence in registry reports") %>% 
    forest.meta(x=.,
              comb.fixed = F,
              rightcols = c("effect", "ci", "w.random"),
              study.results =  T,
              overall = T,
              xlim=c(0, 0.2),
              colgap.left = "2cm",
              colgap.forest = "1cm",
              layout = "RevMan5", 
              print.I2.ci = T)
```


### Observational studies point prevalence Meta-analysis

1. Only point prevalence is included to minimize error caused by looking at multiple years

```{r}
prevalence1 %>% 
  filter (!is.na(all_ntm_infection),
          is_registry==0,
          last_year_data - first_year_data<2,
          study_design=="cross sectional"
          ) %>%
  metaprop(event = all_ntm_infection,
           n = sample_size_cf,
           studlab = study,
           data = .,
           method = "GLMM",
           sm = "PLOGIT",
           comb.random = TRUE,
           hakn = TRUE,
           title = "NTM infection prevalence in observational studies") %>% 
    forest.meta(x=.,
              comb.fixed = F,
              rightcols = c("effect", "ci", "w.random"),
              study.results =  T,
              overall = T,
              xlim=c(0, 0.5),
              colgap.left = "2cm",
              colgap.forest = "1cm",
              layout = "RevMan5", 
              print.I2.ci = T,
              sortvar = studlab )
```



## According to the year of data collection

```{r}
update.meta(meta.full,
            byvar = before_year, 
            tau.common = F) %>% 
    forest.meta(x=.,
              comb.fixed = F,
              rightcols = c("effect", "ci", "w.random"),
              study.results =  F,
              overall = T,
              xlim=c(0, 0.25),
              colgap.left = "2cm",
              colgap.forest = "1cm",
              layout = "RevMan5", 
              col.by = "black",
              bylab = "First year of data collection",
              test.subgroup.random = T,
              bysort = T)
```
Here, we see reduced heterogeneity in the groups before 2000, 2001 - 2004 and 2005 - 2009. 
The omnibus test shows us that there is a significant reduction in the heterogeneity due to when the data was collected. 

## Subgroup by regions (continents)

We had previously coded North America (NAM) as the reference region. We see that numbers in Australia (AUS) and the Middle-East (ME) are pretty low so we recode them as part of the others group with the Latin-American (LAC) studies.

```{r}
update.meta(meta.full,
            byvar = region1, 
            tau.common = F) %>% 
    forest.meta(x=.,
              comb.fixed = F,
              rightcols = c("effect", "ci", "w.random"),
              study.results =  F,
              overall = T,
              xlim=c(0, 0.2),
              colgap.left = "2cm",
              colgap.forest = "1cm",
              layout = "RevMan5", 
              col.by = "black",
              bylab = "Region",
              test.subgroup.random = T,
              bysort = T)
```

We can also see that there is a significant difference in the effect estimates among the groups. However, the heterogeneity has not changed significantly according to this. 

## Subgroup according to overall quality assessment

We also conduct a subgroup analysis to evaluate if there are different estimates of prevalence of NTM infection according to the Overall risk of bias determined by the JBI tool

```{r}
table(prevalence1$Overall_Q)

update.meta(meta.full,
            byvar = Overall_Q, 
            tau.common = F)
```

The statistical test shows that there is significant difference according to the risk of bias appraisal. We also see that differences in the Low risk group are minimal and may provide a good accuracy of the NTM prevalence.

```{r}
update.meta(meta.full,
            byvar = Overall_Q, 
            tau.common = F) %>% 
  forest.meta (x=.,
             comb.fixed = F,
             study.results = F,
             layout="subgroup",
             colgap.forest.left = "6cm",
             test.subgroup.random =T,
             ff.lr="plain",
             xlim=c(0,0.2),
             print.I2.ci = T,
             bylab="Overall Risk of Bias (JBI)",
             col.by = "black")

```

To finalize these subgroup analyses, I will plot only the low risk of bias studies. 

```{r}
prevalence1 %>% 
  filter(Overall_Q=="Low") %>% 
  drop_na(all_ntm_infection)

   
metaprop(studlab = study,
         event = all_ntm_infection,
         n=sample_size_cf,
         subset = Overall_Q=="Low",
         data = prevalence1,
         method = "GLMM",
         sm = "PLOGIT",
         hakn = TRUE,
         title = "NTM infection prevalence (Low risk of bias studies)"
         ) %>%
  forest.meta(.,
              comb.fixed = F,
              layout="RevMan5",
              colgap.forest.left = "4cm",
              xlim=c(0,0.2),
              print.I2.ci = T,
              prediction = T)
```


# Exploratory meta-analyses

## Multilevel model

The data from some of the studies (particularly registries) is not independent as the same patient may be represented in multiple years. Thus, we can try to control for this dependency by creating an additional level in the meta-analysis. 

We use the `metafor` package to fit multilevel meta-analysis. 

First, we need to calculate the effect size (proportions) using the escalc function
- We specify Logit transformed proportions `"PLO"` as they seem to have better characteristics compared to other transformations _(Schwarzer 2019)_
- the additional variables are appended to the dataframe `infection`

```{r}
infection<- prevalence1 %>% 
  filter(!is.na(all_ntm_infection)) %>% 
  escalc(
    data = .,
    xi=all_ntm_infection, # number of events
    ni=sample_size_cf,  # sample size
    measure="PLO")
```

The function `rma.mv` fits multilevel meta-analysis according to the random option
- `< random = ~ 1 | a/b >` specifies that b is nested in a  
- `< random = ~ a | b >` specifies that a is an inner grouping and b an outer grouping level

```{r}
table(prevalence1$used_registry)

multilv.registry <- rma.mv(yi = yi, 
                     V = vi, 
                     slab = id,
                     data = infection,
                     random = ~ 1 | used_registry/id, 
                     test = "t", 
                     method = "REML")

summary(multilv.registry) 
exp(-3.1103)
```

Now, lets evaluate the variance explained by every level of our hierarchical model. 
Level 3 is the level where we grouped according to registry. 

```{r}
var.comp(multilv.registry)

var.comp(multilv.registry) %>% plot()
```

## Meta-regression: including multiple moderators 

In the `metafor` package, we can use the `rma.uni` function to fit almost all meta-analysis and indicate the moderators (grouping variables) to be used. 

Syntax options for moderators:
 - mods = cbind(mod1,mod2,mod3)
 - mods= ~ mod1 + mod2 + mod3

First, lets validate our results in the meta package by fitting the same model with all studies and no moderators
- _slab_ indicates the study label
- _yi & vi_ indicate the study effect measures, already calculated using escalc
- _method_ specified the fitting method, we use REML

```{r}
metafor.full <- rma.uni(
  yi = yi, 
  vi = vi, 
  slab = id,
  data = infection,
  test = "knha",
  method = "REML")

meta.full$TE.random %>% transf.ilogit()
coef(metafor.full) %>% transf.ilogit()

# provides roughly the same results
```

Now, let us fit a meta-regression model to evaluate the heterogeneity according to our pre-specified subgroups
```{r}
# re-arrange levels of factors
infection$region1 <- relevel(infection$region1, ref="NAM")
levels(infection$region1)

infection$before_year <- infection$before_year %>% 
  as_factor() %>% 
  relevel(ref="2015 or after")
levels(infection$before_year)

metareg <- rma.uni(
  yi = yi, 
  vi = vi,
  mods= ~ region1 + before_year + age_group + study_design, 
  slab = id,
  data = infection,
  test = "knha",
  method = "REML"
  )

summary(metareg) 
```

# Complementary analyses

## Publication bias (funnel plot)

For the meta-analysis of all studies

```{r}
funnel(x=metafor.full,
       xlab="Logit transformed proportions",
       level=c(90, 95, 99), 
       shade=c("white", "gray55", "gray75"),
       legend="bottomright", 
       atransf = transf.ilogit)

```

We observe an asymmetrical plot lacking studies with a smaller proportion of NTM infection

```{r}
regtest(metafor.full)

regtest(metafor.full,
        model = "rma",
        predictor = "sei",
        ret.fit = T)

# Using the estimate of the intercept, we can evaluate an estimate under perfect conditions
transf.ilogit(c(-2.4318,-2.8778,-1.9857))

# for the metaregression 
reg<- regtest(metareg,
        model = "rma",
        predictor = "sei",
        ret.fit = T
        )

```

Interestingly, there is no association between sample size and predictor according to the Egger test altough close to the significance level (p=0.06). When we evaluate this influence after correcting for predictors in metaregression we see that the value is farther from the significance level. 

## Publication bias (Trim & Fill method)

The trim and fill method detects places of asimmetry in the funnel plot and inputs studies to achieve a more balanced estimation. It is used to quantify the degree of small studies bias in our results. 

```{r}
trimfill(metafor.full)

# backtransform logit to proportion
transf.ilogit(-2.7489)
```

No study was inputed using these method and the estimatre did not change at all. 

## Pubication bias (p-value curves)

Mostly used for association studies, where the studies tend to be published if the correlation or effect measure is beyond the significance treshold. If a significant association is actually there, we expect a p-value way below the significance value (like 0.0001 or 0.003 instead of 0.048 or 0.047). 

Thus, we can see the distribution of p-values inside the cohort of studies. 

```{r}
pcurve(meta.full)
```

However, because our meta-analysis is of proportions, the p-value may not be a representative indication of why it is published or not, despite its relationship with the sample size. 

```{r, eval=FALSE}
# Evaluating publication bias through selection models based on p-values seems a bit counterintuitive too
metafor::selmodel(metafor.full,
                  type = "stepfun",
                  steps = 0.5,
                  verbose=T)
```

## Risk of bias appraissal

We will summarize the Quality assessment recorded from the Joanna Briggs tool. Unfortunately, there is no easy way to plot this in R and we have to create a new dataframe that fulfills the requirements of the available tools:

- First column for study labels named `study`
- Then, columns with the risk of bias appraisal coded as Low/Unclear/High and Missing
- Overall quality in last column

```{r, message=F}
require (robvis)
```

First, we select only the variables that contain quality assessment data and transform the data into a `data.frame` object.

We define studies with Low risk of bias as those with an adequate sampling frame, taken from a census or a random sampling, having properly described identification methods and reporting of statistical measures

```{r}
prevalence_rob <- 
  prevalence1 %>% 
  select(study, matches("Q[0-9]"), Overall_Q, study_design, before_year) %>% 
  as.data.frame() 
```

Now, we produce both plots (traffic light and summary) using the rob.summary function from the `dmetar` package

Because we are including all studies here, the traffic light picture is pretty crowded

```{r}
rob.summary(prevalence_rob, 
            name.high="High", 
            name.unclear="Unclear",
            name.low="Low", 
            name.missing = "Missing", 
            studies=prevalence_rob$study, 
            table = T)
```

Thus, we summarize the quality of studies after subsetting the data properly. 

```{r, eval=F}
prevalence_rob %>% 
  filter(study_design=="registry") %>%
  rob.summary(data=., 
            name.high="High", 
            name.unclear="Unclear",
            name.low="Low", 
            name.missing = "Missing", 
            studies=.$study, 
            table = T)


prevalence1 %>%
  filter(study_design=="registry") %>%
  select(study, matches("Q[0-9]"), Overall_Q) %>%
  rename(overall=Overall_Q) %>%
  as.data.frame() %>%
  robvis::rob_traffic_light (
    data=.,
    tool = "Generic",
    psize = 4) 

rob_traffic + 
  theme(text = element_text(size = 20))
```
