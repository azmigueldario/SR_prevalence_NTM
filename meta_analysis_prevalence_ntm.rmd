---
title: "Analysis: systematic review of nontuberculous mycobacteria prevalence in cystic fibrosis"
author: "MDP"
date: "19/07/2021"
output: 
  html_document:
    
    toc: true
    toc_depth: 3
    theme: flatly
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Our systematic review is a comprehensive picture of all studies and registry reports that include prevalence/incidence of _nontuberculous mycobacteria (NTM)_ in _cystic fibrosis_ population

The analysis will be performed in R in a _Github_ version control repository

## Aims
1. Explore our data and summarize it briefly
2. Explore publication bias and produce plots
3. Conduct meta-analysis of selected studies and produce summary plots
4. Perform pre-specified subgroup analysis
5. Conduct exploratory sensitivity analysis

### Suggestions for analysis 

*__July 6, 2021__*

i.	Contemporary cohort, maybe including only data from 2010 and onwards _#done_
ii.	Subgroup by high quality studies according to quality appraisal
iii.	Control for overlap over years in registry studies with the random effects model (dependency in data) _#done_
iv.	Subgroup of registry data vs peer-reviewed data _#done_
v.	Also, subgroup according to dates or regions _#done_

*__July 20, 2021__*

i. Tips for discussion: implications of screening, raising prevalence?, implications of design, baseline status before modulators
ii. Contact canada/australia registries for raw numbers of NTM cases _#done, not available_
iii. Corroborate that the numbers in the UK and ECFS registries match 

# Data wrangling

__*Loading required packages*__

- `dmetar` with its associated packages for some helpful functions
- `meta` for meta-analysis per se

```{r, warning=FALSE, message=FALSE}
# install.packages("meta")
# devtools::install_github("MathiasHarrer/dmetar")
require(dmetar)
require(tidyverse)
require(meta)
require(metafor)
```

## Data import 

We will analyze the prevalence as a proportion and the incidence as a rate, data depending. The data from the study cohort is saved in the working directory as a `___.csv` file. 

To conduct meta-analysis of proportions, we require the following observations per study 
- _sample size_
- _study id_
- _number of events_

Other variables are included to perform subgroup analysis and to conduct exploratory data analysis. 
We start by importing the dataset, changing all character variables to factors and cleaning the class of one of the variables:
- _used_registry_ that contains the name of the registry used
- _qa..._ contains the answers to the questions in the JBI assessment tool

```{r, message=FALSE}
getwd()
prevalence <- read_csv("D:/Git/SR_prevalence_NTM/20210719-data_meta_analysis_qa.csv")  %>% 
  mutate(mabs_infection = as.numeric(mabs_infection)) 


prevalence$used_registry<- fct_explicit_na(prevalence$used_registry, "no")
table(prevalence$used_registry)

glimpse(prevalence)
```

## Data wrangling

To produce more quality plots in the future, I make some modifications to separate the publication year and the name of the author. The function `stringr::str_to_title()` puts the first letter of every string to Upper case.  

```{r}
prevalence <-  prevalence %>% 
  mutate(
    study=stringr::str_to_title(
      gsub("([a-z])([0-9])", "\\1 \\2", prevalence$id))
  )
```

The study design variable may have some weird coding lo let us unify it.  
- Also, let us create a new indicator variable for registry vs others.
- Finally, lets transform into `factor class` all character variables

```{r}
prevalence1<- prevalence %>%
  mutate(study_design=case_when(study_design=="Cross-sectional study" ~ "cross sectional",
                                study_design=="Registry report" ~ "registry",
                                TRUE ~ "cohort"),
         is_registry=case_when(study_design=="registry" ~ 1,
                               TRUE ~ 0)) %>% 
  mutate(across(where(is.character), as_factor))

table(prevalence1$is_registry, prevalence1$study_design)
```

Also, we create indicator variable to group studies according to the dates of data collection, we use 5-years intervals between 2000 and 2020

```{r}
prevalence1<- prevalence1 %>%
  mutate(
    before_year=case_when(
      first_year_data<2000 ~ "2000 or before",
      first_year_data<=2004 ~ "2001-2004",
      first_year_data<=2009 ~ "2005-2009",
      first_year_data<=2014 ~ "2010-2014",
      TRUE ~ "2015 or after")) 

table(prevalence1$before_year)
```

## Cleaning quality assessment data

When we analyze the risk of bias of the included studies, we will require a particular data structure in variables. 

- We used the Joana Briggs appraisal tool for prevalence studies and the answers in the tool have the options Yes, No and Unclear. However, to plot it we need to approximate these options to the ones standardized by cochrane which would be Yes=Low, No=High, Unclear=Unclear. 

```{r}
prevalence1<- prevalence1 %>% 
  mutate_at(.vars = vars(starts_with("Q")), 
            .funs = function(x) recode_factor (x, 
                                       `Yes` = "Low", 
                                       `Unclear` = "Unclear", 
                                       `No` = "High", 
                                       `Missing` = "Missing")) 
```


- Also, for the meta-analysis, we will conduct a sensitivity analysis based on the overall quality of the studies. We make the following definitions based on the author's considerations of the most important factors in the quality appraisal:
    + Low risk must have a low risk in: Adequate sampling frame, sampling scheme, statistical calculation and NTM identification methods
    + High risk if there is a high risk in any of the following: sampling frame, sampling scheme, identification methods, statistical methods, description of the population or standard measurement
    + Unclear risk for all other groups


```{r}
prevalence1 <- 
  prevalence1 %>%
  mutate(Overall_Q=case_when(
    qa_sampleframe=="Yes" & qa_sampling=="Yes" & qa_idmethods=="Yes" & qa_stats=="Yes" ~ "Low",
    qa_sampleframe=="No" | qa_sampling=="No" | qa_idmethods=="No" | qa_standard_measurement=="No" |
      qa_stats=="No" ~ "High",
    TRUE ~ "Unclear")) 
```

Finally we rename the quality assessment variables so they represent more clearly each of the domains of the Joana Briggs tool for quality asessment. 

```{r}
prevalence1 <-  prevalence1 %>% 
  rename(
    "Q1_Sampling_frame"="qa_sampleframe",
    "Q2_Sampling_scheme"="qa_sampling",
    "Q3_Sample_size"="qa_samplesize", 
    "Q4_Population_description"="qa_popdescription", 
    "Q5_Coverage_of_sample"="qa_coveragesample",
    "Q6_Identification_methods"="qa_idmethods", 
    "Q7_Standardized_measurement"="qa_standard_measurement",
    "Q8_Statistical_calculation"="qa_stats",
    "Q9_Response_rate"="qa_responserate") 
```

# Exploratory data analysis 

Let us summarize some aspects of our data. 

- How many studies are registry reports? 
- How many studies include pediatric, mixed or adult population ?  

```{r}
prevalence1 %>% 
  count(study_design) %>% 
  mutate(prop = prop.table(n)*100) 

prevalence1 %>% 
  count(age_group) %>% 
  mutate(prop = prop.table(n)*100)

# excluding registry reports
prevalence1 %>%
  filter(is_registry==0) %>% 
  count(age_group) %>% 
  mutate(prop = prop.table(n)*100)
```

- Summarize the first year of data in the studies 
- What is the range of data_years included in the studies? 

```{r}
quantile(prevalence1$first_year_data, na.rm = T)

ggplot(prevalence1, aes(y=first_year_data)) +
  geom_boxplot() + 
  labs(title= "First year of data in study",
       y="") +
  theme_classic()+
  theme(axis.text.x = element_blank())

# establish number of digits in printed results
options(digits = 5)

# excluding registry reports 
prevalence1 %>% 
  filter(is_registry==0) %>% 
  summarize(
    mean=mean(first_year_data, na.rm=T),
    sd=sd(first_year_data, na.rm=T),
    quantile= quantile(first_year_data, na.rm = T)
  ) %>% 
  as.data.frame() # as.dataframe() prints all decimal values, a tibble does not

prevalence1 %>% 
  filter(is_registry==0) %>% 
  ggplot(aes(y=first_year_data)) +
  geom_boxplot() + 
  labs(title= "First year of data in study",
       subtitle = "No registry reports",
       y="") +
  theme_classic() +
  theme(plot.subtitle=element_text(color="red4"),
        axis.text.x = element_blank()) 

```

- How many were conducted before 2010 and 2000?
    + First, we have to create a new indicator variable that classifies the first year of data in several 5-years groups 

```{r}

prevalence1 %>% 
  filter(is_registry==0) %>% 
  count(before_year) %>% 
  mutate(prop=prop.table(n))

prevalence1 %>% 
  filter(is_registry==0) %>%
  ggplot(aes(x=before_year, fill=factor(before_year)))+
  geom_bar() +
  labs(title= "Frequency of studies by groups of date",
       subtitle = "No registry reports") +
  ylab("") +
  theme_classic()
```

- What is the median sample size of the non-registry studies?
    + Does this change according to the year of data collection?

```{r}
prevalence1 %>% 
  filter(is_registry==0 & !is.na(used_registry)) %>% 
  summarize(
  quantile (sample_size_cf, na.rm=T))

prevalence1 %>% 
  filter(is_registry==0 & !is.na(used_registry)) %>% 
  ggplot(aes(y=sample_size_cf, x=first_year_data)) +
  geom_point() +
  labs (title="Sample size according to year of data",
       subtitle="No registry reports included",
       x="First year of data collection",
       y="Number of CF participants") +
  theme(plot.subtitle = element_text(color="red4"))
 
```

# Meta analysis

## All studies meta-analysis

We will first approximate the prevalence of NTM infection using all data. 
- Numerator: `all_ntm_infection` which contains the number of events
- Denominator: `sample_size_cf`  

```{r}
prevalence1 %>% 
  select(id, all_ntm_infection, sample_size_cf)
```

We drop the studies that do not include a raw count of events

```{r}
table(prevalence$all_ntm_infection, useNA = "always")

infection<- prevalence1 %>% 
  filter (!is.na(all_ntm_infection)) 
```

Then fit our meta-analysis with the `meta::metaprop` function
 - sm=PLOGIT specifies to use the logit transformation for the proportions
 - hakn=TRUE applies an adjustment for more conservative confidence intervals
 - comb.random=T specified a random effects model
 
```{r}
meta.full <- metaprop(event = all_ntm_infection,
                   n = sample_size_cf,
                   studlab = id,
                   data = infection,
                   method = "inverse",
                   sm = "PLOGIT",
                   comb.random = TRUE,
                   hakn = TRUE,
                   title = "NTM infection prevalence")

meta.full
```

Now, lets produce a forest plot for this MA, a little bit crowded

```{r}
forest.meta(meta.full, 
            sortvar = TE,
            predict = TRUE, 
            print.tau2 = FALSE,
            leftlabs = c("Author", "g", "SE"))
```

## Pre-specified subgroup analysis

According to study design, registry or not. 

```{r}
update.meta(meta.full,
            byvar = is_registry, 
            tau.common = F)
# high heterogeneity in both
# subgroup test is significant but not relevant (98.9 vs 99.8)

update.meta(meta.full,
            byvar = study_design, 
            tau.common = T)
# reduced heterogeneity according to study design, lower in cohort studies (82% vs 99%)

registry_only<- prevalence1 %>% 
  filter (is_registry==1 & !is.na(all_ntm_infection))

meta.registry <- metaprop(event = all_ntm_infection,
                   n = sample_size_cf,
                   studlab = id,
                   data = registry_only,
                   method = "inverse",
                   sm = "PLOGIT",
                   comb.random = TRUE,
                   hakn = TRUE,
                   title = "NTM infection prevalence in registry studies")
forest.meta(meta.registry,
            layout="RevMan5")

```

Now, according to the year when the first data was collected.

```{r}
update.meta(meta.full,
            byvar = before_year, 
            tau.common = F)
# we see reduced heterogeneity in some of the periods but the omnibus test is not significant
```

According to regions now

```{r}
update.meta(meta.full,
            byvar = region, 
            tau.common = F)
# reduced heterogeneity in LAC and the Middle east, but still high (>80%)
```

## Multilevel model

The data from some of the studies (particularly registries) is not independent as the same patient may be represented in multiple years. Thus, we can try to control for this dependency by creating an additional level in the meta-analysis. 

We use the `metafor` package to fit multilevel meta-analysis. 

First, we need to calculate the effect size (proportions) using the escalc function
- We specify Logit transformed proportions `"PLO"` as they seem to have better characteristics compared to other transformations _(Schwarzer 2019)_
- the additional variables are appended to the dataframe `infection`

```{r}
infection<- escalc(
  data = infection, 
  xi=all_ntm_infection, # number of events
  ni=sample_size_cf,  # sample size
  measure="PLO")
```

The function `rma.mv` fits multilevel meta-analysis according to the random option
- `< random = ~ 1 | a/b >` specifies that b is nested in a  
- `< random = ~ a | b >` specifies that a is an inner grouping and b an outer grouping level

```{r}
multilv.registry <- rma.mv(yi = yi, 
                     V = vi, 
                     slab = id,
                     data = infection,
                     random = ~ 1 | used_registry/id, 
                     test = "t", 
                     method = "REML") 

summary(multilv.registry)
exp(-3.1103)
```

Now, lets evaluate the variance explained by every level of our hierarchical model. 
Level 3 is the level where we grouped according to registry. 

```{r}
var.comp(multilv.registry)
```


## Including multiple moderators (meta-regression)

In the `metafor` package, we can use the `rma.uni` function to fit almost all meta-analysis and indicate the moderators (grouping variables) to be used. 

Syntax options for moderators:
 - mods = cbind(mod1,mod2,mod3)
 - mods= ~ mod1 + mod2 + mod3

First, lets validate our results in the meta package by fitting the same model with all studies and no moderators
- _slab_ indicates the study label
- _yi & vi_ indicate the study effect measures, already calculated using escalc
- _method_ specified the fitting method, we use REML

```{r}
metafor.full <- rma.uni(
  yi = yi, 
  vi = vi, 
  slab = id,
  data = infection,
  test = "knha",
  method = "REML"
  )

summary(meta.full); 
summary(metafor.full)
coef(metafor.full) %>% exp()

# provides roughly the same results
```

Now, let us fit a meta-regression model to evaluate the heterogeneity according to our pre-specified subgroups
```{r}
# re-arrange levels of factors
infection$region <- relevel(infection$region, ref="NAM")
levels(infection$region)

infection$before_year <- infection$before_year %>% 
  as_factor() %>% 
  relevel(ref="2015 or after")
levels(infection$before_year)

metareg <- rma.uni(
  yi = yi, 
  vi = vi,
  mods= ~ region + before_year + age_group + study_design, 
  slab = id,
  data = infection,
  test = "knha",
  method = "REML"
  )

summary(metareg)
```

# Complementary analyses

## Publication bias

For the meta-analysis of all studies

```{r}
funnel.meta(meta.full,
            xlim = c(-0.5, 2),
            studlab = F)

funnel.meta(meta.full, xlim = c(-0.5, 2),
            contour = c(0.9, 0.95, 0.99),
            col.contour = c("gray75", "gray85", "gray95"))
```

We observe an asymmetrical plot lacking studies with a smaller proportion of NTM infection

```{r}

```

## Risk of bias appraissal


```{r, message=F}
require (robvis)
```

```{r}
prevalence1 %>% 
  mutate_at(vars(contains(qa)), recode, `1` = 5, `2` = 4, `3` = 3, `4` = 2, `5` = 1)
```


We need to accommodate our data to the required form for the package. 

First, we select only the variables that contain quality assessment data and transform the data into a `data.frame` object.

We define studies with Low risk of bias as those with an adequate sampling frame, taken from a census or a random sampling, having properly described identification methods and reporting of statistical measures

```{r}
prevalence_rob <- 
  prevalence1 %>%
  mutate(Overall=case_when(qa_sampleframe=="No" | qa_sampling=="No" | 
                              qa_idmethods=="No" | qa_standard_measurement=="No" | 
                             qa_stats=="No" ~ "High",
                           qa_sampleframe=="Yes" & qa_sampling=="Yes" &
                             qa_idmethods=="Yes" & qa_stats=="Yes" ~ "Low",
                           TRUE ~ "Unclear")) %>% 
  select(slab, contains("qa"), Overall) %>% 
  as.data.frame() 
```

Now, we change the names of the variables so they have more meaning in the resultsing plots. We also recodify the `NA` variables to represent "Missing" for the function

```{r}
prevalence_rob  <- 
  apply(prevalence_rob,
        MARGIN= 2, 
        function(x) fct_explicit_na(x, na_level = "Missing")) %>%
  as.data.frame() %>%
  mutate(across(where(is.character), as.factor))

colnames(prevalence_rob) <- c("Study", "Q1_Sampling_frame","Q2_Sampling_scheme",
                              "Q3_Sample_size", "Q4_Population_description", "Q5_Coverage_of_sample",
                              "Q6_Identification_methods", "Q7_Standardized_measurement", 
                              "Q8_Statistical_calculation", "Q9_Response_rate", "Overall")
```


```{r}
prevalence_rob %>% 
  mutate_at(.vars = vars(starts_with("Q")), 
            .funs = function(x) recode_factor (x, 
                                       `Yes` = "Low", 
                                       `Unclear` = "Unclear", 
                                       `No` = "High", 
                                       `Missing` = "Missing"))
```


Now, we produce both plots (traffic light and summary) using the rob.summary function from the `dmetar` package

Because we are including all studies here, the traffic light picture is pretty crowded

```{r}
rob.summary(prevalence_rob, name.high="No", name.unclear="Unclear",
    name.low="Yes", name.missing = "Missing", studies=prevalence_rob$Study, table = T)
```

```{r}
robvis::rob_traffic_light (prevalence_rob, tool="ROB1", colour = "cochrane", psize = 8)
```

